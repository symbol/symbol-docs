##########
Harvesting
##########

The process of creating new :doc:`blocks <block>` is called harvesting.

The **harvesting account** - called the harvester - gets the :ref:`fees <fees>` for the transactions in the block and :doc:`inflation <inflation>`. This **reward** gives the harvester an incentive to add as many transactions to the block as possible.

********************
Eligibility criteria
********************

The :ref:`importance score <importance-calculation>` determines the probability of an account to harvest the next block in case the account has harvesting turned on and all other accounts are harvesting too.

.. note:: Configuration parameters are editable. The importance score calculation formula and the minimum amount required to harvest may differ for the public network configuration.

The account needs to hold a :properties:`minimum amount <config-network.properties>` of this harvesting mosaic to have importance greater than zero.

Harvesting account owners can use their importance scores to create new blocks either by :ref:`running a node <local-harvesting>` or delegating it to a :ref:`remote node <delegated-harvesting>`.

.. _harvesting-mosaic:

*****************
Harvesting mosaic
*****************

Catapult software allows the :properties:`definition <config-network.properties>` of any :doc:`mosaic <mosaic>` for harvesting purposes to fit the business needs. The catapult test network names this mosaic ``cat.harvest``.

For example, consortium networks can distribute harvesting mosaics between the companies that are running the infrastructure, while other participants need to pay fees in the form of :ref:`currency mosaic <fees>` to consume services.

By contrast, public networks might decide to use the same mosaic for paying transaction fees and running the network.

.. _local-harvesting:

****************
Local harvesting
****************

During the installation of a :doc:`node <node>`, you will be asked to set up an account that will be used to harvest. The :ref:`block header <block-header>` includes the public key and signature generated by
the harvesting account.

Besides, each node can set a **beneficiary public key** to share a percentage of the harvesting rewards (:ref:`fees <fees>` and :doc:`inflation <inflation>`), where the sharing ratio is configurable for each network. When the node does not define a beneficiary, all the rewards go to the block signer.

Local harvesting is secure as long as no one accesses your node instance, which is storing the private key.

.. _delegated-harvesting:

********************
Delegated harvesting
********************

Delegated harvesting enables an account to use a **proxy private key** that can be shared with a node securely. In other words, you can use the importance score of your account to create new blocks without running a node.

To enable delegated harvesting, the account owner has to link its **importance score** to a remote account announcing an :ref:`AccountLinkTransaction <account-link-transaction>`.

Then, the account needs to send a **special encrypted message** to the node via a :doc:`TransferTransaction <transfer-transaction>`. The message must contain the remote's account **proxy private key**  encrypted using AES, so that only the recipient will be able to decipher it.

The node receives an encrypted message using WebSockets. Once the node decrypts the private key of the potential delegated harvester, the node owner can save the account on disk if the candidate meets the requirements. Even if the node disconnects temporarily, for whatever reason, the persistent delegated harvesters will be reestablished once the node reconnects to the network.

Additionally, the use of encrypted message creates a backup of the information for the nodes. If the disk containing the delegated keys becomes corrupted or destroyed, the node owner can retrieve the data by querying the blockchain.

Security-wise, **sharing a proxy private key** with a node does not compromise the original account since:

* The remote account has zero balance.
* The remote account by itself can't transfer the importance to another account.
* The original account receives the resulting fees.

Remote harvesters may not receive the entire reward if the following conditions are met:

*  The network harvesting sharing rate is greater than 0.
*  The node selected has defined a :ref:`beneficiary account <local-harvesting>`.

.. csv-table:: Comparison between local and delegated harvesting
    :header: "", "Local harvesting", "Delegated harvesting"
    :delim: ;

    **Configuration** ; Setup a node.; Activate remote harvesting.
    **Cost** ; The node maintenance (electricity, cost VPN).; AccountLinkTransaction + TransferTransaction announcement fees.
    **Security**; The node stores the private key.;  A proxy private key is shared with a node.
    **Reward**; Total reward. The node owner can share part of the reward with a beneficiary account.; Total reward - node's beneficiary share.

*******
Schemas
*******

.. _account-link-transaction:

AccountLinkTransaction
======================

Announce an AccountLinkTransaction to delegate the account importance to a remote account.

In order for the remote account to be accepted for delegated harvesting, it needs to meet the following conditions:

* It cannot own any mosaics.
* It cannot be a cosignatory of any other account.
* It cannot be a multisig account.
* It cannot already be a remote account for another account.
* It cannot be its own remote account.

Furthermore, for the duration that the account is used as a delegated account, it is restricted from:

* initiating any transactions.
* involvement with any type of transactions.

**Version**: 0x01

**Entity type**: 0x414C

**Inlines**:

* :ref:`Transaction <transaction>` or :ref:`EmbeddedTransaction <embedded-transaction>`

.. csv-table::
    :header: "Property", "Type", "Description"
    :delim: ;

    remoteAccountKey; :schema:`Key <types.cats#L11>`; Remote account public key.
    linkAction; :ref:`LinkAction <link-action>`; Account link action.

.. _link-action:

LinkAction
==========

Enumeration: uint8

.. csv-table::
    :header: "Id", "Description"
    :delim: ;

    0x00; Link account.
    0x01; Unlink account.
